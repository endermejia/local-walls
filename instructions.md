# Database Updates for Granular User Blocking

Run the following SQL commands in your Supabase SQL Editor to implement the granular blocking feature.

## 1. Create/Update `user_blocks` table

If the table doesn't exist:
```sql
create table if not exists public.user_blocks (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  blocker_id uuid references auth.users not null,
  blocked_id uuid references auth.users not null,
  block_messages boolean default false not null,
  block_ascents boolean default false not null,
  unique (blocker_id, blocked_id)
);

alter table public.user_blocks enable row level security;
```

If the table already exists (from previous step), run this to add columns:
```sql
alter table public.user_blocks
add column if not exists block_messages boolean default false not null,
add column if not exists block_ascents boolean default false not null;
```

## 2. RLS Policies for `user_blocks`

Allow users to manage their own blocks.

```sql
create policy "Users can see blocks where they are the blocker"
on public.user_blocks for select
using (auth.uid() = blocker_id);

create policy "Users can insert their own blocks"
on public.user_blocks for insert
with check (auth.uid() = blocker_id);

create policy "Users can update their own blocks"
on public.user_blocks for update
using (auth.uid() = blocker_id);

create policy "Users can delete their own blocks"
on public.user_blocks for delete
using (auth.uid() = blocker_id);
```

## 3. Update Chat Messages Policy

Modify the policy to hide messages if `block_messages` is true (mutual check).

```sql
-- Drop the existing policy
drop policy if exists "participants_can_read" on public.chat_messages;

-- Create the new policy
create policy "participants_can_read"
on public.chat_messages for select
using (
  is_chat_participant(room_id)
  and not exists (
    select 1 from user_blocks
    where (
      (blocker_id = auth.uid() and blocked_id = chat_messages.sender_id)
      or
      (blocker_id = chat_messages.sender_id and blocked_id = auth.uid())
    )
    and block_messages = true
  )
);
```

## 4. Update Route Ascents Policy

Modify the policy to hide ascents if `block_ascents` is true (mutual check).

```sql
-- Drop the existing policy
drop policy if exists "auth_can_read" on public.route_ascents;

-- Create the new policy
create policy "auth_can_read"
on public.route_ascents for select
using (
  (auth.uid() = user_id) -- Always see own ascents
  or
  (
    is_profile_public(user_id) -- Check public profile
    and not exists (
      select 1 from user_blocks
      where (
        (blocker_id = auth.uid() and blocked_id = route_ascents.user_id)
        or
        (blocker_id = route_ascents.user_id and blocked_id = auth.uid())
      )
      and block_ascents = true
    )
  )
);
```
